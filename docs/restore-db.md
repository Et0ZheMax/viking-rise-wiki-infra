# Восстановление БД Wiki.js из бэкапа

Документ описывает безопасное восстановление PostgreSQL базы данных Wiki.js из SQL-дампа, созданного скриптом `scripts/backup_db.py`. Все команды выполняются из корня репозитория `viking-rise-wiki-infra`.

## Предварительные условия

- Установлен Docker Desktop (или Docker Engine) и Docker Compose.
- В корне лежит актуальный `.env` с параметрами подключения к БД (POSTGRES_USER/POSTGRES_PASSWORD/POSTGRES_DB).
- Есть нужный файл дампа `backups/wikijs_db_YYYYMMDD_HHMMSS.sql`.
- Терминал запущен **от имени администратора** (Windows) или через `sudo` (Linux/WSL), чтобы доступ к Docker был без ограничений.

## Шаги восстановления

1. **Остановить приложение, если оно запущено**
   ```bash
   docker compose down
   ```
   Это предотвращает запись новых данных в момент восстановления.

2. **Проверить наличие нужного дампа**
   ```bash
   ls backups
   ```
   Убедитесь, что файл вида `wikijs_db_*.sql` на месте и не пустой.

3. **Запустить только контейнеры db и wiki в фоновом режиме**
   ```bash
   docker compose up -d db wiki
   ```
   Nginx можно поднять после успешного восстановления.

4. **Выполнить восстановление внутри контейнера db**
   Замените `wikijs_db_YYYYMMDD_HHMMSS.sql` на нужный файл дампа:
   ```bash
   docker compose exec -T db psql \
     -U "$POSTGRES_USER" \
     -d "$POSTGRES_DB" \
     -f /backups/wikijs_db_YYYYMMDD_HHMMSS.sql
   ```
   *Что делает команда:*
   - `-T` отключает псевдотерминал, чтобы можно было передавать данные из файла.
   - `-f` указывает путь к дампу внутри контейнера (`/backups` монтируется из `./backups`).

5. **Проверить успешность восстановления**
   - Команда завершается без ошибок в терминале.
   - Можно быстро проверить доступность БД:
     ```bash
     docker compose exec db pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"
     ```

6. **Запустить все сервисы**
   ```bash
   docker compose up -d
   ```
   После старта зайдите на `http://localhost:${PUBLIC_HTTP_PORT}` и убедитесь, что Wiki.js отображает ожидаемые данные.

## Советы и частые ошибки

- Если команда `psql` ругается на неверный пароль — проверьте, что `.env` совпадает с параметрами в момент создания бэкапа.
- При ошибке подключения к контейнеру `db` убедитесь, что Docker запущен и сервис `db` в статусе `running` (`docker compose ps`).
- Для сохранности копируйте готовые дампы из `backups/` на внешний носитель или в облако.
